name: Ubuntu GNOME VNC

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: Update packages
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y

      - name: Create VNC user
        id: user
        run: |
          # Tạo mật khẩu ngẫu nhiên (12 ký tự, chỉ chữ + số)
          PASS=$(head -c 100 /dev/urandom | tr -dc 'A-Za-z0-9' | head -c 12)
          echo "VNC_PASS=$PASS" >> $GITHUB_ENV
          
          # Tạo user vncuser
          sudo useradd -m -s /bin/bash vncuser
          echo "vncuser:$PASS" | sudo chpasswd
          sudo usermod -aG sudo vncuser
          
          echo "User: vncuser"
          echo "Pass: $PASS"

      - name: Install Desktop + VNC
        run: |
          sudo apt-get install -y ubuntu-desktop gnome-shell gdm3
          sudo apt-get install -y tigervnc-standalone-server tigervnc-common novnc websockify

      - name: Setup VNC password
        run: |
          sudo -u vncuser mkdir -p /home/vncuser/.vnc
          echo "$VNC_PASS" | vncpasswd -f | sudo tee /home/vncuser/.vnc/passwd > /dev/null
          sudo chown -R vncuser:vncuser /home/vncuser/.vnc
          sudo chmod 600 /home/vncuser/.vnc/passwd

      - name: Start VNC + noVNC
        run: |
          # Start VNC server trên display :1
          sudo -u vncuser vncserver :1 -geometry 1280x720 -depth 24
          
          # Start noVNC (port 6080)
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update -y
          sudo apt-get install -y ngrok

      - name: Start ngrok tunnel
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          nohup ngrok http 6080 > ngrok.log 2>&1 &
          sleep 5
          curl --silent --show-error http://127.0.0.1:4040/api/tunnels > tunnels.json
          cat tunnels.json
          echo "NGROK_URL=$(jq -r '.tunnels[0].public_url' tunnels.json)" >> $GITHUB_ENV

      - name: Show connection info
        run: |
          echo "=============================="
          echo "🌐 noVNC URL: $NGROK_URL"
          echo "👤 User: vncuser"
          echo "🔑 Pass: $VNC_PASS"
          echo "=============================="
          
          # Giữ session sống
          while true; do sleep 300; done
