name: Ubuntu GNOME + noVNC + Tailscale

on:
  workflow_dispatch:

jobs:
  ubuntu-gnome:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:

      - name: Update and Upgrade System
        run: |
          sudo apt update -y
          sudo apt upgrade -y
          sudo apt autoremove -y

      - name: Install Basic Utilities
        run: |
          sudo apt install -y curl wget git unzip tar build-essential

      - name: Install Docker (Optional)
        run: |
          sudo apt install -y apt-transport-https ca-certificates gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt update -y
          sudo apt install -y docker-ce docker-ce-cli containerd.io
          sudo systemctl enable docker
          sudo systemctl start docker

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Get Tailscale IP
        id: tailscale-ip
        run: |
          TS_IP=$(tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TS_IP"

      - name: Install Google Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt -f install -y
          rm google-chrome-stable_current_amd64.deb

      - name: Install Firefox
        run: |
          sudo apt install -y firefox

      - name: Install GNOME Desktop and VNC/noVNC
        run: |
          sudo apt install -y ubuntu-gnome-desktop gnome-terminal tightvncserver novnc websockify

          # Configure VNC password
          mkdir -p ~/.vnc
          echo "vncpassword" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # Start VNC server on display :1
          vncserver :1 -geometry 1920x1080 -depth 24

          # Start noVNC web access on port 6080
          websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

      - name: Final Check
        run: |
          echo "==========================="
          echo "Ubuntu GNOME + noVNC setup completed!"
          echo "Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "VNC display :1 running, noVNC accessible on port 6080"
          google-chrome --version
          firefox --version
          docker --version || echo "Docker not installed"
          echo "==========================="
